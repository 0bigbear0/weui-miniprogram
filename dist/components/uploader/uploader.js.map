{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/components/uploader/uploader.ts?d6fa","webpack:///./src/components/uploader/uploader.ts"],"names":["Component","options","addGlobalClass","properties","title","type","String","value","sizeType","Array","sourceType","maxSize","Number","maxCount","files","observer","newVal","setData","currentFiles","select","upload","tips","extClass","showDelete","Boolean","data","showPreview","previewImageUrls","ready","methods","previewImage","e","index","currentTarget","dataset","forEach","item","push","url","previewCurrent","chooseImage","uploading","wx","count","length","success","res","invalidIndex","tempFiles","size","ret","triggerEvent","errMsg","total","tempFilePaths","mgr","getFileSystemManager","contents","map","fileContent","readFileSync","obj","i","loading","arrayBufferToBase64","len","newFiles","concat","then","json","urls","oldFiles","catch","err","error","fail","indexOf","deletePic","detail","file","splice"],"mappings":"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","file":"components/uploader/uploader.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./node_modules/@mpflow/webpack-plugin/lib/loaders/page-loader.js?appContext=src&outputPath=components%2Fuploader%2Fuploader!./src/components/uploader/uploader.ts\");\n","module.exports = require(\"!./uploader.ts\")","Component({\n    options: {\n        addGlobalClass: true\n    },\n    properties: {\n        title: {\n            type: String,\n            value: '图片上传'\n        },\n        sizeType: {\n            type: Array,\n            value: ['original', 'compressed']\n        },\n        sourceType: {\n            type: Array,\n            value: ['album', 'camera']\n        },\n        maxSize: {\n            type: Number,\n            value: 5 * 1024 * 1024\n        },\n        maxCount: {\n            // 最多上传多少个文件\n            type: Number,\n            value: 1\n        },\n        files: {\n            // 当前的图片列表, {url, error, loading}\n            type: Array,\n            value: [],\n            observer(newVal) {\n                this.setData({\n                    currentFiles: newVal\n                })\n            }\n        },\n        select: {\n            // 过滤某个文件\n            type: null,\n            value: () => {}\n        },\n        upload: {\n            // 返回Promise的一个文件上传的函数\n            type: null,\n            value: null\n        },\n        tips: {\n            type: String,\n            value: ''\n        },\n        extClass: {\n            type: String,\n            value: ''\n        },\n        showDelete: {\n            // 是否显示delete按钮\n            type: Boolean,\n            value: true\n        }\n    },\n    data: {\n        currentFiles: [],\n        showPreview: false,\n        previewImageUrls: []\n    },\n    ready() {},\n    methods: {\n        previewImage(e) {\n            const { index } = e.currentTarget.dataset\n            const previewImageUrls = []\n            this.data.files.forEach((item) => {\n                previewImageUrls.push(item.url)\n            })\n            this.setData({\n                previewImageUrls,\n                previewCurrent: index,\n                showPreview: true\n            })\n        },\n        chooseImage() {\n            if (this.uploading) return\n            wx.chooseImage({\n                count: this.data.maxCount - this.data.files.length,\n                sizeType: this.data.sizeType,\n                sourceType: this.data.sourceType,\n                success: (res) => {\n                    // console.log('chooseImage resp', res)\n                    // 首先检查文件大小\n                    let invalidIndex = -1\n                    // @ts-ignore\n                    res.tempFiles.forEach((item, index) => {\n                        if (item.size > this.data.maxSize) {\n                            invalidIndex = index\n                        }\n                    })\n                    if (typeof this.data.select === 'function') {\n                        const ret = this.data.select(res)\n                        if (ret === false) {\n                            return\n                        }\n                    }\n                    if (invalidIndex >= 0) {\n                        this.triggerEvent(\n                            'fail',\n                            {\n                                type: 1,\n                                errMsg: `chooseImage:fail size exceed ${this.data.maxSize}`,\n                                total: res.tempFilePaths.length,\n                                index: invalidIndex\n                            },\n                            {}\n                        )\n                        return\n                    }\n                    // 获取文件内容\n                    const mgr = wx.getFileSystemManager()\n                    const contents: ArrayBuffer[] = res.tempFilePaths.map((item) => {\n                        // @ts-ignore\n                        const fileContent: ArrayBuffer = mgr.readFileSync(item)\n                        return fileContent\n                    })\n                    const obj = {\n                        tempFilePaths: res.tempFilePaths,\n                        tempFiles: res.tempFiles,\n                        contents\n                    }\n                    // 触发选中的事件，开发者根据内容来上传文件，上传了把上传的结果反馈到files属性里面\n                    this.triggerEvent('select', obj, {})\n                    const files = res.tempFilePaths.map((item, i) => ({\n                        loading: true,\n                        // @ts-ignore\n                        url: `data:image/jpg;base64,${wx.arrayBufferToBase64(contents[i])}`\n                    }))\n                    if (!files || !files.length) return\n                    if (typeof this.data.upload === 'function') {\n                        const len = this.data.files.length\n                        const newFiles = this.data.files.concat(files)\n                        this.setData({\n                            files: newFiles,\n                            currentFiles: newFiles\n                        })\n                        this.loading = true\n                        this.data\n                            .upload(obj)\n                            .then((json) => {\n                                this.loading = false\n                                if (json.urls) {\n                                    const oldFiles = this.data.files\n                                    json.urls.forEach((url, index) => {\n                                        oldFiles[len + index].url = url\n                                        oldFiles[len + index].loading = false\n                                    })\n                                    this.setData({\n                                        files: oldFiles,\n                                        currentFiles: newFiles\n                                    })\n                                    this.triggerEvent('success', json, {})\n                                } else {\n                                    this.triggerEvent(\n                                        'fail',\n                                        {\n                                            type: 3,\n                                            errMsg: 'upload file fail, urls not found'\n                                        },\n                                        {}\n                                    )\n                                }\n                            })\n                            .catch((err) => {\n                                this.loading = false\n                                const oldFiles = this.data.files\n                                res.tempFilePaths.forEach((item, index) => {\n                                    oldFiles[len + index].error = true\n                                    oldFiles[len + index].loading = false\n                                })\n                                this.setData({\n                                    files: oldFiles,\n                                    currentFiles: newFiles\n                                })\n                                this.triggerEvent(\n                                    'fail',\n                                    {\n                                        type: 3,\n                                        errMsg: 'upload file fail',\n                                        error: err\n                                    },\n                                    {}\n                                )\n                            })\n                    }\n                },\n                fail: (fail: any) => {\n                    if (fail.errMsg.indexOf('chooseImage:fail cancel') >= 0) {\n                        this.triggerEvent('cancel', {}, {})\n                        return\n                    }\n                    fail.type = 2\n                    this.triggerEvent('fail', fail, {})\n                }\n            })\n        },\n        deletePic(e) {\n            const index = e.detail.index\n            const files = this.data.files\n            const file = files.splice(index, 1)\n            this.setData({\n                files,\n                currentFiles: files\n            })\n            this.triggerEvent('delete', { index, item: file[0] })\n        }\n    }\n})\n"],"sourceRoot":""}